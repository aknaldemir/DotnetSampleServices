# .NET RabbitMQ Sample Services - Mimar? Dokümantasyonu

## ?? Proje Genel Bak??

Bu proje, **WCF (Windows Communication Foundation)** ile bir ileti gönderim servisi ve **.NET 8 Worker Service** ile bir ileti tüketim servisi aras?nda **RabbitMQ** kullanarak asenkron haberle?meyi gösterir.

### Projeler:
- **WCFServiceRabbitMQ** - .NET Framework 4.7.2 (Producer - Üretici)
- **RabbitMQ.Consumer** - .NET 8 (Consumer - Tüketici)

---

## ??? Sistem Mimarisi

```
???????????????????????????????????????????????????????????????????
?                         ?stemci Uygulamas?                      ?
?????????????????????????????????????????????????????????????????
                     ?
                     ? HTTP/SOAP ?stek
                     ?
???????????????????????????????????????????????????????????????????
?          WCFServiceRabbitMQ (Producer)                          ?
?          .NET Framework 4.7.2                                    ?
?  ????????????????????????????????????????????????????????????   ?
?  ?  MessageDispatcherService (IMessageDispatcherService)    ?   ?
?  ?  - SendMessage(string message)                           ?   ?
?  ?    ??? RabbitMqProducer.Publish(message)               ?   ?
?  ?        ??? Veritaban?na log kayd? (Logs tablosu)      ?   ?
?  ????????????????????????????????????????????????????????????   ?
?????????????????????????????????????????????????????????????????
                     ?
                     ? RabbitMQ Protocol (AMQP)
                     ? Exchange: app.direct.exchange
                     ? RoutingKey: app.routing.create
                     ? Queue: app.queue
                     ?
???????????????????????????????????????????????????????????????????
?                    RabbitMQ Message Broker                      ?
?  ????????????????????????????????????????????????????????????   ?
?  ?  Exchange: app.direct.exchange (Direct Type)            ?   ?
?  ?       ?                                                  ?   ?
?  ?  Queue: app.queue                                       ?   ?
?  ?  (Durable, Non-exclusive, No Auto-delete)              ?   ?
?  ????????????????????????????????????????????????????????????   ?
?????????????????????????????????????????????????????????????????
                     ?
                     ? Mesajlar? Tüket
                     ?
???????????????????????????????????????????????????????????????????
?          RabbitMQ.Consumer (Consumer)                           ?
?          .NET 8 Worker Service                                   ?
?  ????????????????????????????????????????????????????????????   ?
?  ?  Worker (BackgroundService)                             ?   ?
?  ?  - ExecuteAsync(CancellationToken)                     ?   ?
?  ?    ??? AsyncEventingBasicConsumer                      ?   ?
?  ?        ??? ProcessMessageAsync(message)                ?   ?
?  ?            ??? Veritaban?na mesaj kayd?               ?   ?
?  ?                (MQMessages tablosu)                    ?   ?
?  ????????????????????????????????????????????????????????????   ?
?????????????????????????????????????????????????????????????????
                     ?
                     ? SQL Ba?lant?s?
                     ?
???????????????????????????????????????????????????????????????????
?                    SQL Server Veritaban?                        ?
?  ????????????????????????????????????????????????????????????   ?
?  ? Logs Tablosu (WCFServiceRabbitMQ taraf?ndan)            ?   ?
?  ? - Text (log mesajlar? ve hatalar)                       ?   ?
?  ????????????????????????????????????????????????????????????   ?
?  ? MQMessages Tablosu (RabbitMQ.Consumer taraf?ndan)       ?   ?
?  ? - Message (RabbitMQ'dan gelen mesajlar)                 ?   ?
?  ????????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????????
```

---

## ?? Proje Detaylar?

### 1. WCFServiceRabbitMQ (Producer / Üretici)

**Teknoloji Stack:**
- .NET Framework 4.7.2
- WCF (Windows Communication Foundation)
- RabbitMQ.Client v7.2.0
- SQL Server

**Dosyalar:**

#### `IMessageDispatcherService.cs`
```
WCF hizmet sözle?mesini tan?mlar
??? SendMessage(string message): void
    - ?stemciler taraf?ndan ça?r?lan ana operasyon
```

#### `MessageDispatcherService.svc.cs`
```
WCF hizmet uygulamas?
??? SendMessage(string message)
    ??? RabbitMqProducer.Publish(message) - Mesaj? kuyru?a koy
    ??? LogInfo(message) - Ba?ar?l? i?lem logla
    ??? catch (Exception) -> LogError(ex) - Hata logla
```

#### `RabbitMqProducer.cs`
```
RabbitMQ ba?lant?s? ve yay?n mant???
??? Constructor
?   ??? ConnectionFactory olu?tur (localhost:5672)
?   ??? Ba?lant? kur
?   ??? Kanal aç
?   ??? Exchange, Queue ve Binding olu?tur
?
??? Publish(string message)
    ??? Mesaj? UTF-8'e dönü?tür
    ??? BasicProperties (Persistent=true) ayarla
    ??? BasicPublish() ile kuyru?a gönder
```

#### RabbitMQ Konfigürasyonu:
```
Host: localhost
Port: 5672
Username: guest
Password: guest
Exchange: app.direct.exchange (Direct Type)
Queue: app.queue
RoutingKey: app.routing.create
Durable: true
```

---

### 2. RabbitMQ.Consumer (Consumer / Tüketici)

**Teknoloji Stack:**
- .NET 8 (LTS)
- Worker Service
- RabbitMQ.Client v7.2.0
- Microsoft.Data.SqlClient v6.1.3

**Dosyalar:**

#### `Program.cs`
```
Uygulamay? ba?lat?r ve ba??ml?l?klar? kaydettirir

??? Host.CreateApplicationBuilder()
??? RabbitMqOptions yap?land?r (appsettings.json'dan)
??? Worker'? HostedService olarak ekle
??? host.Run()
```

#### `RabbitMqOptions.cs`
```
RabbitMQ ayarlar?n? tutan yap? s?n?f?

??? Host: string (RabbitMQ sunucusu)
??? Port: int (RabbitMQ portu)
??? Username: string
??? Password: string
??? Queue: string
??? PrefetchCount: ushort (prefetch say?s?)
```

#### `Worker.cs` (BackgroundService)
```
Asenkron ileti tüketim hizmetini uygular

??? StartAsync(CancellationToken)
?   ??? InitRabbitMqAsync() - RabbitMQ ba?lant?s? kur
?
??? ExecuteAsync(CancellationToken)
?   ??? AsyncEventingBasicConsumer olu?tur
?   ??? ReceivedAsync event handler
?   ?   ??? Mesaj? UTF-8 string'e dönü?tür
?   ?   ??? ProcessMessageAsync(message) ça??r
?   ?   ??? BasicAckAsync() - Mesaj ba?ar?yla i?lendi
?   ?   ??? catch -> BasicNackAsync(requeue: true) - Yeniden dene
?   ?
?   ??? BasicConsumeAsync() - Kuyru?u tüket
?
??? InitRabbitMqAsync()
    ??? ConnectionFactory olu?tur
    ??? Connection ve Channel aç
    ??? BasicQosAsync() - Prefetch ayarla (QoS)
    ??? QueueDeclareAsync() - Kuyru?u yap?land?r
```

#### `ProcessMessageAsync(string message)`
```
Al?nan mesaj? SQL Server'a kaydeder

??? Connection açmak
??? SQL komutu: INSERT INTO MQMessages (Message) VALUES (@Message)
??? ExecuteNonQuery()
```

#### appsettings.json
```json
{
  "ConnectionStrings": {
    "DbConnection": "SQL Server ba?lant? dizesi"
  },
  "RabbitMQSettings": {
    "Host": "192.168.1.102",
    "Port": 5672,
    "Username": "guest",
    "Password": "guest",
    "Queue": "app.queue",
    "PrefetchCount": 5
  }
}
```

---

## ?? ?leti Ak??? (Workflow)

### Ba?ar?l? Senaryo:

```
1. ?stemci ? WCFServiceRabbitMQ
   POST /MessageDispatcherService.svc
   Gövde: "Merhaba RabbitMQ"

2. MessageDispatcherService.SendMessage()
   ??? RabbitMqProducer.Publish() ça?r?
   ?   ??? RabbitMQ'ya mesaj gönder ?
   ?
   ??? LogInfo() ça?r?
       ??? SQL: INSERT INTO Logs ...

3. RabbitMQ'da Kuyrulanma
   Queue: app.queue
   Mesaj: "Merhaba RabbitMQ"

4. RabbitMQ.Consumer Worker
   ??? BasicConsumeAsync() ile kuyru?u izle
   ??? Mesaj al?nd?
   ?   ??? ReceivedAsync event tetiklenir
   ?
   ??? ProcessMessageAsync(message) ça?r?
   ?   ??? SQL: INSERT INTO MQMessages ...
   ?
   ??? BasicAckAsync() - Mesaj ba?ar?yla i?lendi ?

5. Sonuç
   ? Logs tablosunda: "Merhaba RabbitMQ"
   ? MQMessages tablosunda: "Merhaba RabbitMQ"
```

### Hata Senaryo (Consumer'da hata olu?ursa):

```
1. ProcessMessageAsync() içinde Exception

2. Exception Handler
   ??? BasicNackAsync(requeue: true)
       - Mesaj kuyru?a geri konur
       - Consumer bunu tekrar i?lemeye çal???r

3. Log: "Mesaj i?lenemedi"
```

---

## ?? RabbitMQ Tasar?m?

### Exchange Türü: Direct
- **Amaç**: Belirli routing key ile selective mesaj da??t?m?
- **Binding**: Queue ? Exchange (RoutingKey: "app.routing.create")

### Queue Özellikleri:
```
- Durable: true     (Sunucu yeniden ba?lansa mesajlar kal?r)
- Exclusive: false  (Birden fazla consumer ba?lanabilir)
- AutoDelete: false (Tüm consumer'lar ba?lant?y? kesince silinmez)
```

### QoS (Quality of Service):
```
PrefetchCount: 5
- Consumer'a ayn? anda en fazla 5 mesaj gönderilir
- Consumer her mesaj? i?ledikten sonra ack göndermeli
```

---

## ?? Veritaban? ?emas?

### SQL Server Tables

**Logs Tablosu** (WCFServiceRabbitMQ taraf?ndan):
```sql
CREATE TABLE Logs (
    Id INT IDENTITY PRIMARY KEY,
    Text NVARCHAR(MAX) NOT NULL,
    CreatedAt DATETIME DEFAULT GETDATE()
);
```

**MQMessages Tablosu** (RabbitMQ.Consumer taraf?ndan):
```sql
CREATE TABLE MQMessages (
    Id INT IDENTITY PRIMARY KEY,
    Message NVARCHAR(MAX) NOT NULL,
    ProcessedAt DATETIME DEFAULT GETDATE()
);
```

---

## ?? Çal??t?rma Yönergeleri

### Ön Ko?ullar:
1. RabbitMQ Server (v3.x+) çal???yor mu?
   ```
   Host: 192.168.1.102
   Port: 5672
   Credentials: guest / guest
   ```

2. SQL Server ba?lant?s? aç?k m??
   ```
   Server: 192.168.1.102,1433
   Database: Toki
   Credentials: sa / ak2100382
   ```

### Ba?lang?ç:

**1. WCFServiceRabbitMQ (Producer)**
```
Visual Studio'da sa? t?kla ? IIS Express ile ba?lat
veya
Endpoint: http://localhost/WCFServiceRabbitMQ/MessageDispatcherService.svc
```

**2. RabbitMQ.Consumer (Consumer)**
```
dotnet run
```

### Test Etme:

**WCF Test Client kullanarak:**
```
1. Visual Studio ? MessageDispatcherService.svc'ye sa? t?kla
2. WCF Test Client aç
3. SendMessage() operasyonunu çift t?kla
4. Request de?eri gir: "Test Mesaj?"
5. Invoke butonuna t?kla
```

**PowerShell kullanarak:**
```powershell
$url = "http://localhost/WCFServiceRabbitMQ/MessageDispatcherService.svc"
# SOAP iste?i gönder (veya SoapUI kullan)
```

---

## ?? Bile?en Sorumluluklar?

| Bile?en | Sorumluluk |
|---------|-----------|
| **IMessageDispatcherService** | WCF sözle?mesini tan?mla |
| **MessageDispatcherService** | ?stemci isteklerini i?le, RabbitMQ'ya gönder |
| **RabbitMqProducer** | RabbitMQ ba?lant?s? ve yay?n |
| **RabbitMqOptions** | RabbitMQ ayarlar?n? tut |
| **Worker (Consumer)** | Kuyru?u dinle, mesajlar? i?le |
| **SQL Server** | Mesaj ve log kal?c?l??? |

---

## ?? Ba??ml?l?k Enjeksiyonu

### WCFServiceRabbitMQ:
- Manual instance: `new RabbitMqProducer()`
- ConfigurationManager ile connection string'ler

### RabbitMQ.Consumer:
```csharp
builder.Services.Configure<RabbitMqOptions>(
    builder.Configuration.GetSection("RabbitMQSettings"));
```
- ILogger enjeksiyonu
- IConfiguration enjeksiyonu
- IOptions<RabbitMqOptions> enjeksiyonu

---

## ?? Güvenlik Notlar?

?? **Uyar?**: Üretim ortam?nda:
1. Ba?lant? dizeleri ve kimlik bilgilerini **appsettings.json'dan ç?kar**
2. Azure Key Vault veya Secret Manager kullan
3. SQL Server para

metreleri (SqlParameter) kullan ? (Zaten yap?l?yor)
4. RabbitMQ sunucusuna TLS/SSL ba?lant?s? kur
5. Güvenli parolalar kullan

---

## ?? Ölçeklendirilme

### Yatay Ölçeklendirme:
```
Birden fazla Consumer instance ba?lat:
??? Ayn? queue'yu dinlerler
??? RabbitMQ mesajlar? otomatik olarak da??t?r (load-balance)
```

### Hata Tolerans?:
```
- Queue Durable: true ? Mesajlar korunur
- Consumer Ack: Manuel ? Ba?ar?s?z mesajlar yeniden i?lenir
- Requeue: true ? Network hatalar? için yeniden dene
```

---

## ?? Debugging ve Monitoring

### RabbitMQ Management UI:
```
http://192.168.1.102:15672
Kullan?c?: guest
?ifre: guest

?zleyebilece?iniz:
- Active connections
- Kuyruktaki mesaj say?s?
- Tüketici say?s?
- Mesaj throughput
```

### Uygulamay? ?zleme:
```
RabbitMQ.Consumer konsol ç?kt?s?:
- "Mesaj al?nd?: {msg}"
- "Mesaj i?lenemedi" (hatalar)
- "RabbitMQ ba?lant?s? kuruldu (v7.x)"
```

---

## ?? Kaynaklar

- [RabbitMQ Official Documentation](https://www.rabbitmq.com/documentation.html)
- [RabbitMQ Client Library for .NET](https://www.rabbitmq.com/tutorials/tutorial-one-dotnet.html)
- [WCF Documentation](https://docs.microsoft.com/en-us/dotnet/framework/wcf/)
- [.NET Worker Service](https://docs.microsoft.com/en-us/dotnet/core/extensions/workers)
- [SQL Server Best Practices](https://docs.microsoft.com/en-us/sql/relational-databases/best-practices)

---

## ?? Versiyon Bilgisi

| Bile?en | Versiyon |
|---------|----------|
| .NET Framework (WCF) | 4.7.2 |
| .NET (Consumer) | 8.0 |
| RabbitMQ.Client | 7.2.0 |
| SQL Server | Compatible with 2016+ |
| C# | 12.0 |

---

## ?? Kontribütör

Proje: [DotnetSampleServices](https://github.com/aknaldemir/DotnetSampleServices)

